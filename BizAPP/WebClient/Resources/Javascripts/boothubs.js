BizAPP.UI.Hub={Boot:function(a,f,g,d,b,c,e){addLog("Hub-Boot");if(a!=""&&f!=""){addLog("Starting push services...");$.when($.getScript(a+"/signalr/hubs")).done(function(){if($.connection.hub&&$.connection.hub.state===$.signalR.connectionState.disconnected){var l=$.connection.systemAlertHub;l.client.notifyText=BizAPP.UI.Hub.SystemAlert.TextCallback;l.client.notifySystemAlert=BizAPP.UI.Hub.SystemAlert.AlertInfoCallback;var n=$.connection.webRtcHub;n.client.sendWebRTCMsg=BizAPP.UI.Hub.WebRTC.MessageReceivedCallback;n.client.sendReconnectedMsg=BizAPP.UI.Hub.WebRTC.ReconnectedMsgCallback;n.client.sendWhiteboardMsg=BizAPP.UI.Hub.WebRTC.WhiteboardMsgCallback;n.client.updateParticipantList=BizAPP.UI.Hub.WebRTC.UpdateParticipantCallback;if(g!==undefined&&g!=""){addLog("Setting up user lounge for id ID="+g);var j=$.connection.loungeHub;j.client.notifyActionAlert=BizAPP.UI.Hub.Lounge.ActionAlertInfoCallback;j.client.notifySystemAlert=BizAPP.UI.Hub.Lounge.SystemAlertInfoCallback;j.client.notifyEvent=BizAPP.UI.Hub.Lounge.EventInfoCallback;j.client.notifyProgressUpdate=BizAPP.UI.Hub.Lounge.ProgressUpdateCallback;var m="";var k=f.split(";");if(k.length>2){m=g+";"+k[2]}$.connection.hub.qs={sessionid:f,userid:g,tuserid:m,fullname:d,photo:""};var h=$.connection.chatHub;h.client.startConversation=BizAPP.Collaboration.setChatWindow;h.client.sendTextMessage=BizAPP.Collaboration.addMessage;h.client.setPresenceStatus=BizAPP.Collaboration.setPresenceStatus;h.client.addUsersToConversation=BizAPP.Collaboration.setChatWindow;h.client.sendInfoMessage=BizAPP.Collaboration.addInfoMessage;h.client.sendErrorMessage=BizAPP.Collaboration.addErrorMessage;h.client.sendUserTypingMessage=BizAPP.Collaboration.receiveTypingMessage}else{addLog("Not setting up a user lounge as user id is not there");$.connection.hub.qs={sessionid:f}}$.connection.hub.url=a+"/signalr";$.connection.hub.start({waitForPageLoad:false}).done(function(){addLog("Connected with ID="+$.connection.hub.id);BizAPP.UI.Hub.Initialize($.connection,e);if(c){c()}}).fail(function(){addLog("Could not connect to BizAPP push services!");BizAPP.UI.Hub.Failed()})}})}},Initialize:function(a,d){addLog("Hub-Initialize-"+a.hub.id);try{var e=a.hub.qs.userid;if(e!==undefined&&e!=""&&d.loadChat){BizAPP.Collaboration.Init(e,$.connection.chatHub)}}catch(b){addLog("error initializing hub - "+b.message)}BizAPP.Collaboration.toggleCtrl()},Failed:function(){addLog("Hub-Failed")},Disconnect:function(){$.connection.hub.stop()}};BizAPP.UI.Hub.SystemAlert={TextCallback:function(b){addLog(b);BizAPP.UI.Toast.Notify({title:"System Alert",text:b,type:"info"})},AlertInfoCallback:function(b){try{addLog(JSON.stringify(b));var e={title:b.Title,text:b.Message,shadow:true};if(b.NonBlocking!=null){e.nonblock={nonblock:b.NonBlocking,nonblock_opacity:0.2}}e.history={history:false,menu:false};if(b.HasHistory!=null){e.history.history=b.HasHistory;e.history.menu=b.HasHistory}e.buttons={closer:true,sticker:true};if(b.ShowClose!=null){e.buttons.closer=b.ShowClose}if(b.ShowPin!=null){e.buttons.sticker=b.ShowPin}if(b.AutoDisplay!=null){e.auto_display=b.AutoDisplay}if(b.AutoHide!=null){e.hide=b.AutoHide}if(b.DelayMS!=null){e.delay=b.DelayMS}var d=b.Icon.toLowerCase();switch(d){case"alert":e.type="notice";break;default:e.type=d;break}BizAPP.UI.Toast.Notify(e)}catch(c){addLog("error when trying to notify-"+c.message)}}};BizAPP.UI.Hub.WebRTC={MessageReceivedCallback:function(a){var a=JSON.parse(a);if(a.message.isV3){if(a.message.data&&a.message.data.message&&a.message.data.message.newParticipationRequest){sessions[a.message.data.sender]=a.message.data.message.sessionDetails}}else{sessions[a.message.sessionid]=a.message}if(onMessageCallbacks[a.channel]){onMessageCallbacks[a.channel](a.message)}},ReconnectedMsgCallback:function(a){a=JSON.parse(a);if(!BizAPP.UI.Collaboration.connection.isInitiator&&System.OnlineConference.OnHostArrived){System.OnlineConference.OnHostArrived({oc:a.message.onlineconf,callback:function(){BizAPP.UI.Collaboration.Join(BizAPP.UI.Collaboration._options)}})}else{if(BizAPP.UI.Collaboration){if(!BizAPP.UI.Collaboration.connection.isInitiator&&BizAPP.UI.Collaboration.connection.sessionid==a.message.sessionid){location.reload()}}else{if(a.message.sender!==$.connection.hub.qs.userid){BizAPP.Session.EvaluateExpression({htmlFriendly:true,expression:'<a style="cursor:pointer; color: black" target="_blank" href="viewdetails.aspx?html.args=runtimeviewenterpriseid[NVS][!!%vieweid%!!][PMS]runtimeobjectid[NVS]'+a.message.onlineconf+'">[!!%host.fullname%!!] has invited you to join the training room "[!!%title%!!]" with id [!!%conferenceid%!!]</a>',contexts:a.message.onlineconf,callback:function(b){PNotify.removeAll();BizAPP.UI.Toast.Notify({text:b,type:"info",icon:"fa fa-desktop",after_init:function(c){c.attention("flash")}})}})}}}},UpdateParticipantCallback:function(a){if(BizAPP.UI.Collaboration&&BizAPP.UI.Collaboration.allAttendees){var a=JSON.parse(a);BizAPP.UI.Collaboration.allAttendees=BizAPP.UI.Collaboration.allAttendees+","+a.message.newUserId}},WhiteboardMsgCallback:function(a){BizAPP.UI.Whiteboard.MsgCallback(a)}};BizAPP.UI.Hub.Lounge={ActionAlertInfoCallback:function(b){BizAPP.UI.Hub.Lounge.InternalActionAlertInfoCallback(b)},ActionAlertCallback:null,InternalActionAlertInfoCallback:function(a){try{addLog(JSON.stringify(a));if(a.Type=="javascript"){eval(a.Message);return}var options={title:a.Title,text:a.Message,shadow:true};if(a.NonBlocking!=null){options.nonblock={nonblock:a.NonBlocking,nonblock_opacity:0.2}}options.history={history:false,menu:false};if(a.HasHistory!=null){options.history.history=a.HasHistory;options.history.menu=a.HasHistory}options.buttons={closer:true,sticker:true};if(a.ShowClose!=null){options.buttons.closer=a.ShowClose}if(a.ShowPin!=null){options.buttons.sticker=a.ShowPin}if(a.AutoDisplay!=null){options.auto_display=a.AutoDisplay}if(a.AutoHide!=null){options.hide=a.AutoHide}if(a.DelayMS!=null){options.delay=a.DelayMS}if(!a.Icon){a.Icon="alert"}var icon=a.Icon.toLowerCase();switch(icon){case"alert":options.type="notice";break;default:options.type=icon;break}BizAPP.UI.Toast.Notify(options);if(BizAPP.UI.Hub.Lounge.ActionAlertCallback){BizAPP.UI.Hub.Lounge.ActionAlertCallback(a)}}catch(err){addLog("error when trying to notify-"+err.message)}},SystemAlertInfoCallback:function(b,d){try{addLog(JSON.stringify(b));var g={title:b.Title,text:b.Message,shadow:true};if(b.NonBlocking!=null){g.nonblock={nonblock:b.NonBlocking,nonblock_opacity:0.2}}g.history={history:false,menu:false};if(b.HasHistory!=null){g.history.history=b.HasHistory;g.history.menu=b.HasHistory}g.buttons={closer:true,sticker:true};if(b.ShowClose!=null){g.buttons.closer=b.ShowClose}if(b.ShowPin!=null){g.buttons.sticker=b.ShowPin}if(b.AutoDisplay!=null){g.auto_display=b.AutoDisplay}if(b.AutoHide!=null){g.hide=b.AutoHide}if(b.DelayMS!=null){g.delay=b.DelayMS}var f=b.Icon==null?"notice":b.Icon.toLowerCase();switch(f){case"alert":g.type="notice";break;default:g.type=f;break}BizAPP.UI.Toast.Notify(g)}catch(e){addLog("error when trying to notify-"+e.message)}},EventInfoCallback:function(b,g){try{addLog(JSON.stringify(b));var d=b.Message;if(d==null){d=""}var e={title:b.Title,text:d,shadow:true};if(b.NonBlocking!=null){e.nonblock={nonblock:b.NonBlocking,nonblock_opacity:0.2}}e.history={history:false,menu:false};if(b.HasHistory!=null){e.history.history=b.HasHistory;e.history.menu=b.HasHistory}e.buttons={closer:true,sticker:true};if(b.ShowClose!=null){e.buttons.closer=b.ShowClose}if(b.ShowPin!=null){e.buttons.sticker=b.ShowPin}if(b.AutoDisplay!=null){e.auto_display=b.AutoDisplay}if(b.AutoHide!=null){e.hide=b.AutoHide}if(b.DelayMS!=null){e.delay=b.DelayMS}var f=b.Type;switch(f){case"0":e.type="info";break;case"1":e.type="error";break;case"2":e.type="notice";break;case"3":e.type="success";break;default:e.type=f==null?"info":f.toLowerCase();break}BizAPP.UI.Toast.Notify(e);jBeep("resources/sounds/NotifyMessaging.wav")}catch(c){addLog("error when trying to notify event-"+c.message)}},ProgressUpdateCallback:function(b,k){try{addLog(JSON.stringify(b));var d=b.Id;var e=null;$(PNotify.notices).each(function(a,l){if(l.options.id==d){e=l;return false}});var h=b.Title;var g=b.PercentCompleted;if(e!=null){if(g>=100){e.remove();return}else{e.update({title:h,})}progress=e.get().find("progress.progress-bar");progress[0].value=g}else{var f={id:d,title:h,text:'<progress class="progress-bar" style="margin:0; width:100%; border: 0;" value="0" max="100"></progress>',icon:"fa fa-spinner fa-spin",shadow:true,hide:false,buttons:{closer:false,sticker:false},history:{history:false},before_open:function(a){progress=a.get().find("progress.progress-bar");progress[0].value=g}};if(b.NonBlocking!=null){f.nonblock={nonblock:b.NonBlocking,nonblock_opacity:0.2}}f.history={history:false,menu:false};f.buttons={closer:false,sticker:false};if(b.ShowClose!=null){f.buttons.closer=b.ShowClose}if(b.ShowPin!=null){f.buttons.sticker=b.ShowPin}if(b.AutoDisplay!=null){f.auto_display=b.AutoDisplay}if(b.AutoHide!=null){f.hide=b.AutoHide}if(b.DelayMS!=null){f.delay=b.DelayMS}var j=b.Type;switch(j){case"0":f.type="info";break;case"1":f.type="error";break;case"2":f.type="notice";break;case"3":f.type="success";break;default:f.type=j==null?"info":j.toLowerCase();break}BizAPP.UI.Toast.Notify(f);jBeep("resources/sounds/NotifyMessaging.wav")}}catch(c){addLog("error when trying to notify event-"+c.message)}}};BizAPP.Collaboration={_chatPanel:'<div id="chat-panel">							<div class="chat-window-title">									<div class="text" style="display:inline;">Chat</div>									<div style="float:right;display:inline;" onclick="BizAPP.Collaboration.toggleCtrl();"><div class="balloon_white">=</div></div>							   </div>						  <div class="bza_chatuserlist chat-window" style="right: 10px;">							  <div class="chat-window-content">								  <input type="text" id="chatCtactSrch" bza_qid="ESystemae76f" bza_fields="Full Name" style="line-height:24px;padding:0;width:100%" placeholder="Search..."/>								   <div class="ui-icon ui-icon-arrowrefresh-1-e refresh-contact-list" title="Refresh Contact List" onclick="BizAPP.Collaboration.DisplayRecentContact($.connection.hub.qs.userid);" style="float:right;"></div>								  <div class="chat-window-inner-content">								  </div>							  </div>						  </div>						  <div id="chatContainer-tabs">							  <ul></ul>						  </div>					  </div>',_tabbed:true,_tabbedChatWindow:'<div class="bza_chat chat-window" id = "{0}" style="display: none">						<table class="fill">						<tr>							<td style="width:90%;">								<div class="inviteNewUser" style="display:none">									<input type="text" class="inviteUser"  bza_qid="ESystemae76f" bza_fields="Full Name" placeholder="Search..."/>								</div>								<div class="participants" style="color: #638EB5;font-weight: bold;">								</div>							</td>							<td>								<span class="icon_inviteUser" title="Add user to this chat" onclick="$(this).closest(\'tr\').find(\'.inviteNewUser\').slideToggle(200);$(this).closest(\'tr\').find(\'.participants\').slideToggle(200);"><img src = "Resources/Images/people.png" /></span>							</td>							<td>								<div class="popout" title="Pop-out" style="float:right;margin-right:4px;"><img src="Resources/Images/operationu.png"></div>							</td>						</tr>					</table>					<div class="chat-window-content" style="display: block;">						<div class="chat-window-inner-content"></div>						<div class="chat-window-text-box-wrapper">							<textarea rows="3" class="chat-window-text-box" style="overflow: hidden; word-wrap: break-word; resize: none;" autofocus></textarea>							<span class="hint" style="color:gray;font-style:italic;font-size:11px;float:right;">Press "Enter" to send message</span>						</div>					</div>				</div>',_chatMsg:'<div class="chat-message">							<div class="chat-gravatar-wrapper">								<img class="profile-picture" src="testresource.aspx?resize=1&h=25&w=25&id2=ESystema4d6a&userid={2}">							</div>							<div class="chat-text-wrapper">								<span class="sender-title" style="line-height:25px">{0}</span>								<p class="msg_time" style="color:#B5B5B5;font-size:11px;float:right;">{3}</p>								<pre>{1}</pre>							</div>						</div>',_msg:'<p class="msg_time" style="color:#B5B5B5;font-size:11px;text-align:right;">{1}</p><pre>{0}</pre>',_chatMsgCurrentUser:'<div style="padding:.5rem; border: solid 1px; border-radius:.5rem .5rem 0; max-width: 75%;background:#5D5D6D; margin-bottom: .5rem; margin-left: 25%">							<div class="active" style="background-color: transparent;font-size: 0.9rem;color: #ccc;">{1}</div>							<div style="text-align:right; font-size: 0.7rem;color: #ccc;">{3}</div>						</div>',_chatMsgOtherUser:'<div style="padding:.5rem; border: solid 1px; border-radius:.5rem .5rem .5rem 0; max-width: 75%;background:#5D5D5D; margin-bottom: .5rem">							<div class="active" style="background-color: transparent;font-size: 0.9rem;color: #ccc;">{1}</div>							<div style="text-align:right; font-size: 0.7rem;color: #ccc;">{0} - {3}</div>						</div>',_errormsg:'<pre style ="color:red;">{0}</pre>',_infomsg:'<pre style ="color:orange;">{0}</pre>',_init:false,_initContacts:false,_chatHub:null,currentUserId:null,fullName:null,photo:null,newMessage:"new-message",Init:function(c,a){addLog("chat init");BizAPP.Collaboration.currentUserId=c;var e=location.href.toLowerCase().indexOf("collaboration.aspx")!=-1;if(!e){var d=$(".chat-panel").length>0;if(!d){$("body").append($(BizAPP.Collaboration._chatPanel));$("#chat-panel").click(function(f){f.stopPropagation();BizAPP.MenuPopup.HideOrRemovePopup()})}}if(c){var b=Persist.Stack.PeekValue("conversationPopout");c=e&&(b!=undefined)?Persist.Stack.PeekValue("convPopoutOpener"):c;e==true?$("body").append($(Persist.Stack.PeekValue("existingConversation"))):e;e==true?$("title").text(b):e}if(e){Persist.Stack.Clear("convPopoutOpener");Persist.Stack.Clear("existingConversation")}BizAPP.Collaboration._chatHub=a;BizAPP.Collaboration._init=true;BizAPP.Collaboration.joined($.connection.hub.id,null);BizAPP.Collaboration.StoreConversation();BizAPP.Collaboration.RestoreConversation()},joined:function(b,d){if(!BizAPP.Collaboration._init){setTimeout(function(){BizAPP.Collaboration.joined(b,d)},1000)}if(d){$(d).each(function(f,h){var e=h.split(",")[0],g=h.split(",")[1];$(".bza_chatuserlist .chat-window-inner-content").append('<div class="user-list-item">								<div class="chat-gravatar-wrapper">									<img class="profile-picture" src="testresource.aspx?resize=1&h=25&w=25&id2=ESystema4d6a&userid='+e+'" style="background:grey">								</div>								<div class="profile-status"></div>								<div class="content" uid="'+e+'">'+g+"</div>							</div>")})}BizAPP.UI.Textbox.EnhanceAutoComplete({selector:"#chatCtactSrch",userStatus:"true",selectCallback:function(e,f){if(f.item.status=="1"){BizAPP.Collaboration.InitiateChat(f.item.value);BizAPP.Collaboration.AddUserToRecentContact(f)}else{alert("User is offline")}}});$(".bza_chatuserlist .chat-window-inner-content .user-list-item").dblclick(function(){var e=$(this).find(".content").attr("uid");BizAPP.Collaboration.InitiateChat(e)});var c=location.href.toLowerCase().indexOf("collaboration.aspx")!=-1;c==true?$(".bza_chat.chat-window").find("textarea").keydown(function(e){return BizAPP.Collaboration.sndMsg(e)}):c;var a=$(".bza_chat.chat-window");$.each(a,function(){BizAPP.Collaboration.EnableAutoComplete($(this))})},GetOrCreateChatWindow:function(b,d,f,e){var a=$('div[chatToId="'+b+'"]'),c=a.length==0;f=f.trim();if(a.length==0&&!e){if(!f){BizAPP.Collaboration._chatHub.server.getParticipants(b)}$(".chat-window-title").click();var a=$(BizAPP.Collaboration._tabbedChatWindow.format(b));if(BizAPP.Collaboration._tabbed){a.attr("groupname",b);$("#chatContainer-tabs ul").append($('<li><a href="#'+b+'" style="outline:none;width:67%">'+f+'</a><span class="ui-icon ui-icon-close" role="presentation">Remove Tab</span></li>)'))}a.attr("chatToId",b);if(d){a.attr("groupname",b);a.css("display","block")}$("#chatContainer-tabs").append(a);$("#chatContainer-tabs").tabs({activate:function(g,j){var h=j.newTab.find("a[href]").attr("href");$(h).find("textarea").focus();j.newTab.removeClass(BizAPP.Collaboration.newMessage);setTimeout(function(){j.newTab.find("a").show()},700)}});$("#chatContainer-tabs").tabs("refresh");$("#chatContainer-tabs").tabs("option","active",-1);a.find("textarea").keydown(function(g){return BizAPP.Collaboration.sndMsg(g)});a.find(".popout").bind("click",function(g){BizAPP.Collaboration.PopoutChatWindow($(this))})}a.find("textarea").focus();if(c){a.find(".popout").click(function(){BizAPP.Collaboration.PopoutChatWindow($(this))});BizAPP.Collaboration.EnableAutoComplete(a);BizAPP.Collaboration.EnableTabClose($("#chatContainer-tabs"))}return[a,c]},ShowMsg:function(a,k,e,d,j){if($("#chat-panel:visible").length==0){BizAPP.SystemTray.Highlight($("#bt-menu .fa-comments").parent())}if(j=="Error"||j=="Info"){a[0].find(".chat-window-inner-content .chat-text-wrapper:last").append(j=="Error"?BizAPP.Collaboration._errormsg.format(d):BizAPP.Collaboration._infomsg.format(d))}else{var f=BizAPP.Collaboration.IgnoreRepeatedUserInfo(a[0],e,d);var h=BizAPP.Collaboration.GetTime();var g=$("<div></div>").html(d);if(g.text()!=d){d=$("<div/>").text(d).html()}if(k==_userUid__){a[0].find(".chat-window-inner-content").append(BizAPP.Collaboration._chatMsgCurrentUser.format(e,d,k,h))}else{a[0].find(".chat-window-inner-content").append(BizAPP.Collaboration._chatMsgOtherUser.format(e,d,k,h))}}if(k!=$.connection.hub.qs.userid){var c=$('[aria-controls="'+a[0].attr("id")+'"]');if(!c.hasClass("ui-state-active")){c.addClass(BizAPP.Collaboration.newMessage);BizAPP.Collaboration.UnreadMessageHint("."+BizAPP.Collaboration.newMessage+" a")}BizAPP.Collaboration.ShowNotification(e,d,"","testresource.aspx?userid="+k);jBeep("resources/sounds/notifymessaging.wav")}BizAPP.Collaboration.Smilify(a[0].find(".chat-window-inner-content .chat-message pre").last());var b=location.href.toLowerCase().indexOf("collaboration.aspx")!=-1,l=b?window.opener:window;l.$("button.signin").click()},PopoutChatWindow:function(a){if(!a.attr("popout")){Persist.Stack.PushValue("conversationPopout",a.closest(".bza_chat.chat-window").attr("id"));Persist.Stack.PushValue("convPopoutOpener",$("#chat-panel .chat-window-title").find(".text").text().trim());Persist.Stack.PushValue("existingConversation",a.closest(".bza_chat.chat-window")[0].outerHTML);a.attr("popout","fullscreen");var b=a.closest(".bza_chat").attr("groupname");$('a[href="#'+b+'"]').next().click();$("#chatContainer-tabs").tabs("refresh");var c=window.open("collaboration.aspx","newwindow","width=300, height=400");BizAPP.Collaboration.RemoveGrpIdFromStackOnClose(c)}},IgnoreRepeatedUserInfo:function(a,f,e){var c=false;var d=a.find(".chat-text-wrapper:last .sender-title").text().trim();var b=f.trim();if(b==d){c=true}return c},addMessage:function(c,g){var l=g.SenderId,f=g.Message,h=BizAPP.Collaboration.getUserName(g.SenderId),e;var d=location.href.toLowerCase().indexOf("collaboration.aspx")!=-1;if(!d){var k=getPersistedValue("conversationPopout","value");if(k){k=JSON.parse(k);if($.inArray(c,k)>=0){return}}}var b=BizAPP.Collaboration.GetOrCreateChatWindow(c,true,"");if(b[0].find('[popout="fullscreen"]').length){return false}if(e){var m=BizAPP.Collaboration.ExcludeCurrentUser(e);b[0].find(".participants").text(e);if(!b[1]){var a=$('a[href = "#'+b[0].attr("id")+'"]');a.text(m);a.attr("title",m)}}BizAPP.Collaboration.ShowMsg(b,l,h,f);if(h.trim()!=$.connection.hub.qs.fullname.trim()){$(".chat-window-title").find('[class*="balloon"]').addClass("blink");BizAPP.Collaboration.BlinkChatIcon($(".chat-window-title").find('[class*="balloon"]'))}b[0].find(".chat-window-inner-content").scrollTop(10000);var j={};j.item={value:l,label:" - "+h};BizAPP.Collaboration.AddUserToRecentContact(j)},addInfoMessage:function(b,c){var a=BizAPP.Collaboration.GetOrCreateChatWindow(b,true,"");BizAPP.Collaboration.ShowMsg(a,"","",c.Info,"Info")},addErrorMessage:function(b,e){var h="",d=e.Error,f="";var c=location.href.toLowerCase().indexOf("collaboration.aspx")!=-1;if(!c){var g=getPersistedValue("conversationPopout","value");if(g){g=JSON.parse(g);if($.inArray(b,g)>=0){return}}}var a=BizAPP.Collaboration.GetOrCreateChatWindow(b,true,"");if(a[0].find('[popout="fullscreen"]').length){return false}BizAPP.Collaboration.ShowMsg(a,h,f,d,"Error");$(".chat-window-title").find('[class*="balloon"]').addClass("blink");BizAPP.Collaboration.BlinkChatIcon($(".chat-window-title").find('[class*="balloon"]'));a[0].find(".chat-window-inner-content").scrollTop(10000)},setPresenceStatus:function(b,a){addLog("UserStatusChanged-"+b+"-Status-"+a);var c=BizAPP.Collaboration.GetRecentContact($.connection.hub.qs.userid);if(c){$.each(c,function(){var d=this;if(d.id==b){if(a==1){$('.user-list-item .content[uid="'+b+'"]').prev().attr("class","profile-status online")}if(a==0){$('.user-list-item .content[uid="'+b+'"]').prev().attr("class","profile-status offline")}}})}},SendTypingMessage:function(a){var b=$(a.target).closest(".bza_chat").attr("groupname");addLog("sending Typing status");BizAPP.Collaboration._chatHub.server.sendUserTypingItem(b,{Id:b,SenderId:BizAPP.Collaboration.currentUserId,Message:"typing message"})},receiveTypingMessage:function(b,c){var a=BizAPP.Collaboration.GetOrCreateChatWindow(b,true,""),e=c.SenderId,d=BizAPP.Collaboration.getUserName(c.SenderId);if(e!=BizAPP.Collaboration.currentUserId){a[0].find(".chat-user-typing").css("display","block");a[0].find(".chat-user-typing").html(d+" is typing...")}addLog("group Id "+b);addLog("message item details"+JSON.stringify(c))},sndMsg:function(a){if(a.keyCode&&a.keyCode=="13"){strChatText=$(a.target).val().trim();if(strChatText!=""){var b=$(a.target).closest(".bza_chat").attr("groupname");if(typeof b!=="undefined"&&b!==false){BizAPP.Collaboration._chatHub.server.sendTextItem(b,{Id:b,SenderId:BizAPP.Collaboration.currentUserId,Message:strChatText});$(a.target).val("")}}}else{return true}},getUserName:function(b){if(b==BizAPP.Collaboration.currentUserId){return $.connection.hub.qs.fullname}var a=$('.user-list-item .content[uid="'+b+'"]').text();if(!a){if(window.sessionStorage){a=window.sessionStorage.getItem("chat_fn_"+b)}if(!a){a=BizAPP.Session.EvaluateExpression({expression:"%fullname%",contexts:b+":uid_user:-1:",sync:true}).value[1].replace(/"/g,"");window.sessionStorage.setItem("chat_fn_"+b,a)}}return a},_getUserNames:function(a){var b="";$.each(a,function(){if(this!=BizAPP.Collaboration.currentUserId){if(b){b+=", "}b+=BizAPP.Collaboration.getUserName(this)}});return b},setChatWindow:function(f,c){var d=c.join(",");var e=BizAPP.Collaboration._getUserNames(c);if($(".grpIdUpdationRequired").length>0){var b=$(".grpIdUpdationRequired").attr("groupname");$(".grpIdUpdationRequired").attr({groupname:f,chattoid:f,id:f});$(".grpIdUpdationRequired").removeClass("grpIdUpdationRequired");$('[href="#'+b+'"]').attr("href","#"+f);$('[aria-controls="'+b+'"]').attr("aria-controls",f)}var a=BizAPP.Collaboration.GetOrCreateChatWindow(f,false,e)[0];a.attr({groupname:f,chattoid:f,id:f});$('.ui-tabs-anchor[href="#'+d+'"]').attr("href","#"+f).text(e).attr("title",e);a.find(".participants").text($.connection.hub.qs.fullname+","+e);a.css("display","block");$("#chatContainer-tabs").find("#chatContainer-tabs").tabs();BizAPP.Collaboration.EnableTabClose($("#chatContainer-tabs"));BizAPP.Collaboration.EnableAutoComplete(a);BizAPP.Collaboration.StoreParticipant(f,d)},InitiateChat:function(a){BizAPP.Collaboration._chatHub.server.createConversation([a])},toggleCtrl:function(){var b=$(".bza_chatuserlist");if(b.is(":visible")){$("#chat-panel").height("0");$("#chat-panel").width("auto");$(".balloon_white").removeClass("balloon_white").addClass("balloon_blue");var c=$(".chat-window-title");c.css("background","none");c.find('[class*="balloon"]').text("");c.hide()}else{$('#chat-panel:not(".bza-notifn")').height("100%");$("#chat-panel").width("314");$(".balloon_blue").removeClass("balloon_blue").addClass("balloon_white");$(".chat-window-title").css("background","#123F76");$(".chat-window-title").find('[class*="balloon"]').text("=");if(!isIE()&&Notification.permission!=="granted"){Notification.requestPermission();addLog("Permission granted for notification")}}$("#chat-panel .text").toggle();b.toggle();$("#chatContainer-tabs").toggle();$(".chat-window-title").find('[class*="balloon"]').removeClass("blink");$(".bza_chat.chat-window:visible:eq(0) textarea").focus()},InviteUser:function(b,a){if(!a.startsWith("bzacidhash_")){$.connection.chatHub.server.addUsersToConversation(a,[b]);BizAPP.Collaboration.StoreParticipant(a,b);$('div[chatToId="'+a+'"]').addClass("grpIdUpdationRequired");addLog(b+" successfully added in the group")}else{var c=BizAPP.Collaboration.GetParticipants(a);c=c.split(",");c.push(b);BizAPP.Collaboration._chatHub.server.createConversation(c)}},EnableAutoComplete:function(a){BizAPP.UI.Textbox.EnhanceAutoComplete({selector:".inviteUser",userStatus:"true",selectCallback:function(c,d){if(d.item.status=="1"){BizAPP.Collaboration.InviteUser(d.item.value,a.find(".inviteUser").closest("[groupname]").attr("groupname"))}else{alert("User is offline")}$(".inviteUser").val("")}})},EnableTabClose:function(a){var b=a.tabs();b.delegate("span.ui-icon-close","click",function(){var c=$(this).closest("li").find("a").attr("href");$(this).closest("li").remove();$(c).remove();b.tabs("refresh")})},StoreConversation:function(){window.onunload=function(){BizAPP.UI.Hub.Disconnect();var a=$("#chatContainer-tabs"),b=$.connection.hub.qs;if(a.find(".chat-window").length&&a.find("ul a").length){Persist.Stack.StoreValue("openChat"+b.userid,a.html());Persist.Stack.StoreValue("chatSessionId"+b.userid,b.sessionid);addLog("Conversation saved for "+b.fullname)}else{Persist.Stack.Clear("openChat"+b.userid)}}},RestoreConversation:function(){$(document).ready(function(){var d=$.connection.hub.qs,c=Persist.Stack.PeekValue("openChat"+d.userid),b=Persist.Stack.PeekValue("chatSessionId"+d.userid);if(d.sessionid==b){if(c!=null&&c.length){var a=$("#chatContainer-tabs");a.find("*").remove();a.append($(c));addLog("Conversation restored for :"+d.fullname);a.tabs();BizAPP.Collaboration.EnableEvents(a,a.find(".chat-window"));a.find(".chat-window textarea").keydown(function(e){return BizAPP.Collaboration.sndMsg(e)})}else{Persist.Stack.Clear("openChat"+d.userid)}}})},EnableEvents:function(b,a){a.find(".popout").click(function(){BizAPP.Collaboration.PopoutChatWindow($(this))});BizAPP.Collaboration.EnableTabClose(b)},BlinkChatIcon:function(a){if($(a).hasClass("blink")&&$(a).hasClass("balloon_blue")){$(a).fadeOut("slow",function(){$(this).fadeIn("slow",function(){BizAPP.Collaboration.BlinkChatIcon(this)})})}},GetTime:function(){return new Date().toString("hh:mm tt")},RemoveGrpIdFromStackOnClose:function(a){var b=setInterval(function(){if(a.closed){clearInterval(b);var c=$(a.document).find("[groupname]").attr("groupname");var d=getPersistedValue("conversationPopout","value");if(d){d=JSON.parse(d);if($.inArray(c,d)>=0){d.splice($.inArray(c,d),1);persistValue("conversationPopout","value",JSON.stringify(d));$('[groupname="'+c+'"]').find('[popout="fullscreen"]').removeAttr("popout")}}}},1000)},AddUserToRecentContact:function(b){if(b.item.value==BizAPP.Collaboration.currentUserId){return}var d=false,a=b.item.label.split("- ")[1],e=BizAPP.Collaboration.GetRecentContact(BizAPP.Collaboration.currentUserId);$(e).each(function(){if(this.id==b.item.value){d=true;addLog(a+" already exists in recent contact list");return}});if((!d)&&(!e||e.length<=50)){var c={id:b.item.value,label:a};Persist.Stack.PushValue("recentContact"+BizAPP.Collaboration.currentUserId,c);addLog(a+" is added in recent contact list");BizAPP.Collaboration.DisplayRecentContact(BizAPP.Collaboration.currentUserId)}},GetRecentContact:function(b){var a=getPersistedValue("recentContact"+b,"value");if(a){a=JSON.parse(a);a=a.sort(function(c,e){var d=c.label.toLowerCase();var f=e.label.toLowerCase();return((d<f)?-1:((d>f)?1:0))})}return a},DisplayRecentContact:function(b){$(".bza_chatuserlist .chat-window-inner-content").html("");var d=BizAPP.Collaboration.GetRecentContact($.connection.hub.qs.userid),a="offline",c=null;if(d){c=jQuery.map(d,function(e){return e.id})}if(c){$.connection.chatHub.server.getUsersWithStatus(c).done(function(e){$(d).each(function(g,j){var f=j.id,h=j.label;a="offline";if(e&&parseInt(e[c.indexOf(f)])){a="online"}$(".bza_chatuserlist .chat-window-inner-content").append('<div class="user-list-item">									<div class="user-det"></div>									<div class="chat-gravatar-wrapper">										<img class="profile-picture" src="testresource.aspx?resize=1&h=25&w=25&id2=ESystema4d6a&userid='+f+'">									</div>									<div class="profile-status '+a+'"></div>									<div class="content" uid="'+f+'">'+h+'</div>									<div class="custom-action" style="float:right;margin-right:25px;margin-top: -17px;display:none;">										<i class="fa fa-ellipsis-v" style="line-height: 25px; padding: 0px 0.3rem; font-size: 1.1rem;"></i>										<i class="fa fa-remove" style="line-height: 25px; padding: 0px 0.3rem; font-size: 1.1rem;"></i>									</div>								</div>')});$(".bza_chatuserlist .chat-window-inner-content .user-list-item").hover(function(){$(this).css("background","whitesmoke");$(this).find(".custom-action").show()},function(){$(this).find(".custom-action").hide();$(this).css("background","none")});$(".bza_chatuserlist .chat-window-inner-content .fa-ellipsis-v").on("click",function(f){f.stopPropagation();var g=$(this).closest(".user-list-item").find(".bza-dropdown");if(g.length>0){g.toggleClass("open")}else{BizAPP.UI.LoadView({url:"uiview.asmx?html.args=runtimeviewenterpriseid[NVS]ESystemaf9ec[PMS]runtimeobjectid[NVS]"+$(this).parent().parent().find(".content").attr("uid")+":uid_user:-1&html.jar=true",menuPopupSelector:$(this).closest(".user-list-item").find(".profile-picture"),position:"bottom pleft"})}});$(".bza_chatuserlist .chat-window-inner-content .fa-remove").on("click",function(f){var h=$(this).closest(".user-list-item").find(".content").attr("uid");var j=BizAPP.Collaboration.GetRecentContact(BizAPP.Collaboration.currentUserId);var g=-1;$(j).each(function(k,l){if(l.id==h){g=k;return}});if(i!=-1){j.splice(g,1);Persist.Stack.Clear("recentContact"+BizAPP.Collaboration.currentUserId);persistValue("recentContact"+BizAPP.Collaboration.currentUserId,"value",JSON.stringify(j));$(this).closest(".user-list-item").remove()}});$(".bza_chatuserlist .chat-window-inner-content .user-list-item").on("click",function(f){if(!f.isPropagationStopped()){var g=$(this).find(".content").attr("uid");BizAPP.Collaboration.InitiateChat(g)}})})}else{addLog("Recent contact list is empty")}},ShowNotification:function(f,c,e,b){var a=BizAPP.UI.basePath.replace(/\/$/,"");if(!e){e="bizapp"}if(!b){b=a+"/favicon.ico"}var d=new Notification(f,{body:c,icon:b,tag:e});d.onclick=function(){window.focus()};setTimeout(function(){d.close()},4000)},ExcludeCurrentUser:function(d){var c=$.connection.hub.qs.fullname,b=d.split(",");if($.inArray(c,b)>=0){b.splice($.inArray(c,b),1)}return b.join(",")},Smilify:function(a){$.cachedScript(BizAPP.UI.GetBasePath("Resources/Smiley/smileys.js")).done(function(b,c){$.getCss(BizAPP.UI.GetBasePath("Resources/Smiley/smileys.css"));$(a).smilify()})},UnreadMessageHint:function(a){$(a).fadeOut("slow",function(){$(a).fadeIn("slow",function(){BizAPP.Collaboration.UnreadMessageHint(a)})})},StoreParticipant:function(b,d){var c=Persist.Stack.PeekValue(b);if(!c){c=d;var a=$.unique(c.split(",")).join(",");Persist.Stack.PushValue(b,a)}else{if($.inArray(c.split(","),d)<0){c+=","+d}var a=$.unique(c.split(",")).join(",");Persist.Stack.PushValue(b,a)}},GetParticipants:function(a){return Persist.Stack.PeekValue(a)}};function jBeep(g){if(!g){g="jBeep/jBeep.wav"}var h,j,k;k=true;try{if(typeof document.createElement("audio").play=="undefined"){k=false}}catch(l){k=false}j=document.getElementsByTagName("body")[0];if(!j){j=document.getElementsByTagName("html")[0]}h=document.getElementById("jBeep");if(h){j.removeChild(h)}if(k){h=document.createElement("audio");h.setAttribute("id","jBeep");h.setAttribute("src",g);h.play()}else{if(navigator.userAgent.toLowerCase().indexOf("msie")>-1){h=document.createElement("bgsound");h.setAttribute("id","jBeep");h.setAttribute("loop",1);h.setAttribute("src",g);j.appendChild(h)}else{var m;h=document.createElement("object");h.setAttribute("id","jBeep");h.setAttribute("type","audio/wav");h.setAttribute("style","display:none;");h.setAttribute("data",g);m=document.createElement("param");m.setAttribute("name","autostart");m.setAttribute("value","false");h.appendChild(m);j.appendChild(h);try{h.Play()}catch(l){h.object.Play()}}}}(function(v,x){var a="granted",t="denied",A="unknown";var z=[],y,u=0;function b(c){if(z.length===0){z=[x.title]}z.push(c);if(!y){y=setInterval(function(){if(z.indexOf(x.title)===-1){z[0]=x.title}x.title=z[++u%z.length]},1000)}}function w(){if(z.length===0){return}if("external" in v&&"msSiteModeClearIconOverlay" in v.external){v.external.msSiteModeClearIconOverlay()}clearInterval(y);y=false;x.title=z[0];z=[]}function s(f,d,g){if(d.match(" ")){var c=d.split(" ");for(var e=0;e<c.length;e++){s(f,c[e],g)}}if(f.addEventListener){f.removeEventListener(d,g,false);f.addEventListener(d,g,false)}else{f.detachEvent("on"+d,g);f.attachEvent("on"+d,g)}}function r(){if(("external" in v)&&("msIsSiteMode" in v.external)){return v.external.msIsSiteMode()?a:A}else{if("webkitNotifications" in v){return v.webkitNotifications.checkPermission()===0?a:t}else{if("mozNotification" in v.navigator){return a}else{return A}}}}function q(){v.Notification.permission=r();return v.Notification.permission}if(!Object(v.Notification).permission){s(v,"focus scroll click",w);v.Notification=function(f,e){if(!(this instanceof v.Notification)){return new v.Notification(f,e)}var g,d=this;e=e||{};this.body=e.body||"";this.icon=e.icon||"";this.lang=e.lang||"";this.tag=e.tag||"";this.close=function(){w();if(Object(g).close){g.close()}d.onclose()};this.onclick=function(){};this.onclose=function(){};b(f);if(("external" in v)&&("msIsSiteMode" in v.external)){if(v.external.msIsSiteMode()){v.external.msSiteModeActivate();if(this.icon){v.external.msSiteModeSetIconOverlay(this.icon,f)}}}else{if("webkitNotifications" in v){if(v.webkitNotifications.checkPermission()===0){g=v.webkitNotifications.createNotification(this.icon,f,this.body);g.show();g.onclick=function(){d.onclick();v.focus();setTimeout(function(){g.cancel()},1000)}}}else{if("mozNotification" in v.navigator){var c=v.navigator.mozNotification.createNotification(f,this.body,this.icon);c.show()}}}};v.Notification.requestPermission=function(c){c=c||function(){};if(("external" in v)&&("msIsSiteMode" in v.external)){try{if(!v.external.msIsSiteMode()){v.external.msAddSiteMode();c(A)}}catch(d){}c(q())}else{if("webkitNotifications" in v){v.webkitNotifications.requestPermission(function(){c(q())})}else{c(q())}}};q()}})(window,document);